@model Erp.BackOffice.Sale.Models.SaleReportSumaryViewModel
<div class="widget-box">
    <div class="widget-header">
        <h4 class="widget-title">
            <i class="ace-icon fa fa-line-chart"></i>
            Tổng quan bán hàng
        </h4>
    </div>
    <div class="widget-body">
        <div class="widget-main">
            <p><b>@ViewBag.DateRangeText</b></p>
            @if (Model.IsFilter_ByProductProperty)
            {
                    <div class="row">
                        <div class="col-sm-6">
                            <div class="infobox infobox-green infobox-small infobox-dark">
                                <div class="infobox-icon">
                                    <i class="ace-icon fa fa-dollar"></i>
                                </div>
                                <div class="infobox-data">
                                    <span class="infobox-data-number ng-binding">@Erp.BackOffice.Helpers.Common.PhanCachHangNgan2(Model.Revenue)</span>
                                    <div class="infobox-content">
                                        Tổng doanh thu
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="infobox infobox-blue infobox-small infobox-dark">
                                <div class="infobox-icon">
                                    <i class="ace-icon fa fa-shopping-cart"></i>
                                </div>
                                <div class="infobox-data">
                                    <span class="infobox-data-number ng-binding">@Erp.BackOffice.Helpers.Common.PhanCachHangNgan2(Model.NumberOfProductInvoice)</span>
                                    <div class="infobox-content">Đơn hàng</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="infobox infobox-orange infobox-small infobox-dark">
                                <div class="infobox-icon">
                                    <i class="ace-icon fa fa-dollar "></i>
                                </div>
                                <div class="infobox-data">
                                    <span class="infobox-data-number ng-binding">@Erp.BackOffice.Helpers.Common.PhanCachHangNgan2(Model.SalesReturnAmount)</span>
                                    <div class="infobox-content">Tiền trả hàng</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="infobox infobox-orange infobox-small infobox-dark">
                                <div class="infobox-icon">
                                    <i class="ace-icon fa fa-reply-all"></i>
                                </div>
                                <div class="infobox-data">
                                    <span class="infobox-data-number ng-binding">@Erp.BackOffice.Helpers.Common.PhanCachHangNgan2(Model.NumberOfSalesReturn)</span>
                                    <div class="infobox-content">Đơn hàng trả</div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    if (!string.IsNullOrEmpty(Model.Manufacturer))
                    {
                    <p><b>Nhà sản xuất: @Model.Manufacturer</b></p>
                    }

                    if (!string.IsNullOrEmpty(Model.ProductGroup))
                    {
                    <p><b>Nhóm sản phẩm: @Model.ProductGroup</b></p>
                    }
                    <div class="row">
                        <div class="col-sm-6">
                            <div class="infobox infobox-blue  infobox-small infobox-dark">
                                <div class="infobox-icon">
                                    <i class="ace-icon fa fa-dollar"></i>
                                </div>
                                <div class="infobox-data">
                                    <span class="infobox-data-number ng-binding">@Erp.BackOffice.Helpers.Common.PhanCachHangNgan2(Model.Revenue)</span>
                                    <div class="infobox-content">
                                        Doanh số bán
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="infobox infobox-green  infobox-small infobox-dark">
                                <div class="infobox-icon">
                                    <i class="ace-icon fa fa-cubes"></i>
                                </div>
                                <div class="infobox-data">
                                    <span class="infobox-data-number ng-binding">@Erp.BackOffice.Helpers.Common.PhanCachHangNgan2(Model.NumberOfProductInvoice)</span>
                                    <div class="infobox-content">Số lượng bán</div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            @if (Model.NumberOfProductInvoice_Pendding > 0 || Model.NumberOfProductInvoice_InProgress > 0)
            {
                    <div class="alert alert-warning top-10">
                        <p>
                            @if (Model.NumberOfProductInvoice_Pendding > 0)
                            {
                                <a class="green" href="/ProductInvoice/Index?status=@Resources.Wording.OrderStatus_pending"><b>@Erp.BackOffice.Helpers.Common.PhanCachHangNgan2(Model.NumberOfProductInvoice_Pendding) đơn hàng mới</b></a>
                            }
                            @if (Model.NumberOfProductInvoice_InProgress > 0)
                            {
                                <span>|</span>
                                <a class="orange" href="/ProductInvoice/Index?status=@Resources.Wording.OrderStatus_inprogress"><b>@Erp.BackOffice.Helpers.Common.PhanCachHangNgan2(Model.NumberOfProductInvoice_InProgress) đơn hàng đang xử lý</b></a>
                            }
                        </p>
                    </div>
                }
        </div>
    </div>
</div>


<div class="widget-box top-5">
    <div class="widget-header">
        <h4 class="widget-title">
            Thống kê doanh số theo khách hàng
        </h4>
    </div>
    <div class="widget-body">
        <div class="widget-main">
            <canvas id="bieu_do_doanh_so_theo_khach_hang" width="400" height="300" style="max-width:600px;"></canvas>
        </div>
    </div>
</div>
<div class="widget-box top-5">
    <div class="widget-header">
        <h4 class="widget-title">
            Thống kê doanh số theo nhân viên
        </h4>
    </div>
    <div class="widget-body">
        <div class="widget-main">
            <canvas id="bieu_do_doanh_so_theo_nhan_vien" width="400" height="300" style="max-width:600px;"></canvas>
        </div>
    </div>
</div>

<script type="text/javascript">
    function buildHorizontalBarChart(el, responseData, title) {
        $(function(){
            function createNewDataset(arrayData, label, backgroundColorValue, borderColorValue, borderWidth) {
                var objectDataset = {
                    label: label,
                    backgroundColor: colorRender(backgroundColorValue).alpha(0.5).rgbString(),
                    borderColor: borderColorValue,
                    borderWidth: borderWidth,
                    data: []
                };

                for (var i in arrayData) {
                    objectDataset.data.push(arrayData[i]);
                }

                return objectDataset;
            }

            var xData = [];
            var yData = [];
            for (var i in responseData) {
                xData.push(responseData[i].data);
                yData.push(responseData[i].label);
            }

            var dataPushToDataset = [];
            for (var i in yData) {
                var item = responseData.filter(function(obj){
                    return obj.label.toString() ==  yData[i];
                });

                if (item.length != 0) {
                    dataPushToDataset.push(item[0].data);
                } else {
                    dataPushToDataset.push(0);
                }
            }

            var arrayDataset = [];
            var colorRender = Chart.helpers.color;
            var newDataset = createNewDataset(dataPushToDataset, 'Doanh số', window.chartColors.green, window.chartColors.green, 1);
            arrayDataset.push(newDataset);

            var barChartData = {
                labels: yData,
                datasets: []
            };

            //Khởi tạo cái chart
            $(document).ready(function () {
                var ctx = document.getElementById(el).getContext("2d");
                var chart = new Chart(ctx, {
                    type: 'horizontalBar',
                    data: barChartData,
                    options: {
                        responsive: true,
                        barThickness: 40,
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: false,
                            text: title
                        },
                        animation: {
                            duration: 500,
                            enabled: true,
                        },
                        scales: {
                            yAxes: [
                                {
                                    ticks: {
                                        fontSize: 10,
                                        callback: function (label, index, labels) {
                                            return (index + 1) + '. ' + label;
                                        }
                                    }
                                }
                            ],
                            xAxes: [
                                {
                                    ticks: {
                                        fontSize: 10,
                                        callback: function (label, index, labels) {
                                            return Number(label).toFixed(0).toString().replace(/\d(?=(?:\d{3})+(?!\d))/g,'$&.');
                                        }
                                    },
                                    scaleLabel: {
                                        display: window.outerWidth < 992 ? false : true,
                                        labelString: ''
                                    }
                                }
                            ]
                        },
                        tooltips: {
                            enabled: true,
                            mode: 'single',
                            callbacks: {
                                title: function (tooltipItem, data) {
                                    return data.labels[tooltipItem[0].index];
                                },
                                label: function (tooltipItems, data) {
                                    return Number(tooltipItems.xLabel).toFixed(0).toString().replace(/\d(?=(?:\d{3})+(?!\d))/g,'$&.');
                                }
                            }
                        }
                    }
                });

                setTimeout(function () {
                    for (var i in arrayDataset) {
                        console.log(arrayDataset[i]);
                        barChartData.datasets.push(arrayDataset[i]);
                    }
                    chart.update();
                }, 500);
            });
        });
    }

    var jsonThongKeBanHang_TheoNhanVien = @Html.Raw(ViewBag.jsonThongKeBanHang_TheoNhanVien);
    buildHorizontalBarChart("bieu_do_doanh_so_theo_nhan_vien", jsonThongKeBanHang_TheoNhanVien, "Thống kê doanh số theo nhân viên");

    var jsonThongKeBanHang_TheoKhachHang = @Html.Raw(ViewBag.jsonThongKeBanHang_TheoKhachHang);
    buildHorizontalBarChart("bieu_do_doanh_so_theo_khach_hang", jsonThongKeBanHang_TheoKhachHang, "Thống kê doanh số theo khách hàng");
</script>
